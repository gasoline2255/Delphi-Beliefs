<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Live Market - Delphi Beliefs</title>

  <link rel="icon" type="image/png" href="/favicon.png">
  <link rel="shortcut icon" type="image/png" href="/favicon.png">

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root{
      --bg0:#0A0D1F; --bg1:#0F1229;
      --card: rgba(255,255,255,0.04);
      --border: rgba(255,255,255,0.1);
      --text:#E8EDF5; --soft:#A0AAC0; --muted:#6B7588;
      --blue:#5B9FFF; --orange:#FF9D5C; --green:#00D89F; --red:#FF5C7C;
      --yellow:#FFB84D;
    }
    *{ margin:0; padding:0; box-sizing:border-box; }
    body{ margin:0; font-family: Inter, -apple-system, sans-serif; color: var(--text); background: var(--bg0); min-height: 100vh; }
    .wrap{ max-width: 1280px; margin: 0 auto; padding: 0; }

    /* ‚îÄ‚îÄ‚îÄ Navbar ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    .navbar{
      display:flex; justify-content:space-between; align-items:center;
      padding: 1.25rem 2rem; border-bottom: 1px solid var(--border);
      background: rgba(255,255,255,0.02);
    }
    .nav-left{ display:flex; align-items:center; gap: 3rem; width: 100%; }
    .brand{ display:flex; flex-direction: column; gap: 0.25rem; margin-left: 1rem; }
    .brand h1{ margin:0; font-size: 1.25rem; font-weight: 700; letter-spacing: -0.02em; }
    .brand-subtitle{ font-size: 0.6875rem; color: var(--green); font-weight: 600; letter-spacing: 1.5px; text-transform: uppercase; }
    .nav-tabs{ display: flex; gap: 0.5rem; }
    .nav-tab{
      padding: 0.5rem 1rem; border-radius: 8px; font-size: 0.875rem; font-weight: 600;
      color: var(--soft); text-decoration: none; transition: all 0.2s;
      display: flex; align-items: center; gap: 0.5rem;
    }
    .nav-tab:hover{ color: var(--text); background: rgba(255,255,255,0.05); }
    .nav-tab.active{ color: var(--text); background: rgba(255,255,255,0.08); }
    .nav-tab svg{ width: 14px; height: 14px; }
    .nav-right{ display: flex; align-items: center; gap: 1.5rem; flex-shrink: 0; }
    .built-by{ color: var(--muted); font-size: 0.875rem; white-space: nowrap; }
    .built-by a{ color: var(--text); text-decoration: none; font-weight: 600; }
    .built-by a:hover{ color: var(--blue); }
    .social-links{ display: flex; gap: 0.75rem; flex-shrink: 0; }
    .social-link{
      width: 32px; height: 32px; border: 1px solid var(--border); border-radius: 8px;
      display: flex; align-items: center; justify-content: center; color: var(--soft);
      text-decoration: none; transition: all 0.2s; background: rgba(255,255,255,0.03);
    }
    .social-link:hover{ border-color: var(--blue); color: var(--blue); background: rgba(91,159,255,0.1); }

    /* ‚îÄ‚îÄ‚îÄ Status pill ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    .topbar{ display:flex; justify-content:space-between; align-items:flex-end; margin-bottom: 1.5rem; gap: 1rem; }
    .statusPill{
      display:flex; align-items:center; gap: 0.625rem;
      padding: 0.625rem 1rem; border-radius: 999px; border: 1px solid var(--border);
      background: var(--card); color: var(--soft); font-size: 0.875rem; font-weight: 600;
      transition: all 0.5s ease;
    }
    .statusPill.is-settled{
      border-color: rgba(0,216,159,0.35);
      background: rgba(0,216,159,0.08);
      color: var(--green);
    }
    .dot{
      width:8px; height:8px; border-radius:50%;
      background: var(--green); box-shadow: 0 0 12px var(--green);
      transition: all 0.5s;
    }
    .dot.pulse{ animation: pulse 2s infinite; }
    @keyframes pulse{
      0%,100%{ opacity:1; box-shadow:0 0 12px var(--green); }
      50%{ opacity:0.5; box-shadow:0 0 4px var(--green); }
    }
    .dot.settled{ background: var(--green); box-shadow: none; animation: none; }

    /* ‚îÄ‚îÄ‚îÄ Settled banner ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    .settledBanner{
      display: none;
      align-items: center; gap: 1.25rem; flex-wrap: wrap;
      padding: 1.25rem 1.5rem; border-radius: 16px; margin-bottom: 1.5rem;
      border: 1px solid rgba(0,216,159,0.25);
      background: linear-gradient(135deg, rgba(0,216,159,0.07) 0%, rgba(0,216,159,0.03) 100%);
    }
    .settledBanner.visible{ display: flex; }
    .settledBannerIcon{ font-size: 2rem; line-height: 1; flex-shrink: 0; }
    .settledBannerBody{ flex: 1; min-width: 0; }
    .settledBannerTitle{ font-size: 1rem; font-weight: 800; color: var(--green); margin-bottom: 0.3rem; }
    .settledBannerSub{ font-size: 0.8125rem; color: var(--soft); line-height: 1.5; }
    .settledWinnerChip{
      display: inline-flex; align-items: center; gap: 0.5rem;
      padding: 0.6rem 1.1rem; border-radius: 999px; flex-shrink: 0;
      background: rgba(0,216,159,0.15); border: 1px solid rgba(0,216,159,0.35);
      color: var(--green); font-weight: 800; font-size: 0.875rem;
      font-family: 'JetBrains Mono', monospace;
    }

    /* ‚îÄ‚îÄ‚îÄ Cards ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    .stats{ display:grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-bottom: 1.5rem; }
    @media (max-width: 980px){ .stats{ grid-template-columns: repeat(2, 1fr); } }
    .card{
      border: 1px solid var(--border); border-radius: 16px;
      background: var(--card); overflow:hidden;
      transition: border-color 0.5s, background 0.5s;
    }
    .card.settled-tint{
      border-color: rgba(0,216,159,0.18);
      background: rgba(0,216,159,0.03);
    }
    .cardInner{ padding: 1.25rem; }
    .k{ color: var(--muted); font-size: 0.75rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
    .v{ margin-top: 0.5rem; font-size: 1.125rem; font-weight: 700; line-height: 1.4; min-height: 1.6rem; }
    .splitRow{ display:flex; justify-content:space-between; margin-top: 0.625rem; font-size: 0.8125rem; }
    .subV{ color: var(--soft); }
    .subRight{ color: var(--muted); font-family: 'JetBrains Mono', monospace; }
    .grid{ display:grid; grid-template-columns: 1.6fr 1fr; gap: 1.5rem; }
    @media (max-width: 980px){ .grid{ grid-template-columns: 1fr; } }
    .cardHeader{
      display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap;
      padding: 1rem 1.25rem; border-bottom: 1px solid var(--border);
      background: rgba(255,255,255,0.02); gap: 1rem;
    }
    .cardTitle{ font-weight: 700; font-size: 0.875rem; }
    button{
      font-family: Inter; font-size: 0.8125rem; font-weight: 700; color: var(--text);
      background: rgba(255,255,255,0.06); border: 1px solid var(--border);
      border-radius: 10px; padding: 0.5rem 1rem; cursor:pointer; transition: all 0.2s;
    }
    button:hover{ background: rgba(255,255,255,0.1); border-color: rgba(255,255,255,0.15); }
    .body{ padding: 1.25rem; }

    /* ‚îÄ‚îÄ‚îÄ Chart ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    .chartShell{ border: 1px solid var(--border); border-radius: 12px; background: rgba(255,255,255,0.02); padding: 0.875rem; }
    .chartShell canvas{ width:100% !important; height: 360px !important; display:block; }
    #delphiChartCanvas{ height: 420px !important; }
    .foot{ margin-top: 0.75rem; display:flex; justify-content:space-between; color: var(--muted); font-size: 0.75rem; }

    /* ‚îÄ‚îÄ‚îÄ Hint pills ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    .hintPill{
      display:flex; align-items:center; gap:0.625rem;
      padding: 0.5rem 0.875rem; border-radius: 999px; border: 1px solid var(--border);
      background: var(--card); color: var(--soft); font-size: 0.8125rem;
      transition: all 0.5s ease;
    }
    .hintPill.is-settled{
      border-color: rgba(0,216,159,0.3);
      background: rgba(0,216,159,0.08);
      color: var(--green);
    }
    .miniMetaPill{
      display:flex; align-items:center; gap:0.625rem;
      padding: 0.5rem 0.875rem; border-radius: 999px; border: 1px solid var(--border);
      background: var(--card); color: var(--muted); font-size: 0.75rem;
      font-family: 'JetBrains Mono', monospace; transition: all 0.5s;
    }
    .miniMetaPill.is-settled{
      border-color: rgba(0,216,159,0.3);
      background: rgba(0,216,159,0.08);
      color: var(--green);
    }
    .miniDot{ width:6px; height:6px; border-radius:50%; transition: all 0.5s; }

    /* ‚îÄ‚îÄ‚îÄ Models ranking ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    .modelsList{ display:flex; flex-direction:column; gap:0.75rem; }
    .modelRow{
      display: grid; grid-template-columns: 1fr auto; gap: 0.9rem;
      padding: 1rem 1.05rem; border-radius: 14px; border: 1px solid var(--border);
      background: linear-gradient(180deg, rgba(255,255,255,0.035), rgba(255,255,255,0.02));
      transition: border-color 0.4s, background 0.4s;
    }
    .modelRow.is-winner{
      border-color: rgba(0,216,159,0.35);
      background: linear-gradient(180deg, rgba(0,216,159,0.07), rgba(0,216,159,0.02));
    }
    .mLeft{ display: flex; gap: 0.9rem; min-width: 0; align-items: flex-start; }
    .badge{
      width: 34px; height: 34px; border-radius: 12px;
      display:flex; align-items:center; justify-content:center;
      font-weight: 900; font-size: 0.75rem;
      background: rgba(255,255,255,0.05); border: 1px solid var(--border);
      font-family: 'JetBrains Mono', monospace; flex: 0 0 auto;
    }
    .mMain{ min-width:0; flex: 1; }
    .mTop{ display:flex; align-items: baseline; justify-content: space-between; gap: 0.75rem; }
    .mName{ font-weight: 800; font-size: 0.95rem; letter-spacing: -0.01em; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .mMeta{ margin-top: 0.25rem; display:flex; gap: 0.75rem; align-items:center; flex-wrap: wrap; }
    .mEval{ color: var(--soft); font-size: 0.76rem; font-family: 'JetBrains Mono', monospace; }
    .winnerTag{
      display: inline-flex; align-items: center; gap: 0.3rem;
      padding: 0.2rem 0.6rem; border-radius: 999px;
      background: rgba(0,216,159,0.15); border: 1px solid rgba(0,216,159,0.3);
      color: var(--green); font-size: 0.68rem; font-weight: 700; white-space: nowrap;
    }
    .pct{
      align-self: center; font-family: 'JetBrains Mono', monospace; font-weight: 900;
      font-size: 0.82rem; padding: 0.45rem 0.65rem; border-radius: 999px;
      border: 1px solid var(--border); background: rgba(255,255,255,0.035);
      min-width: 64px; text-align: center;
    }
    .evalHistory{
      margin-top: 0.7rem; padding-top: 0.7rem; border-top: 1px solid rgba(255,255,255,0.07);
      display: flex; gap: 0.5rem; flex-wrap: nowrap; overflow-x: auto; overflow-y: hidden;
      -webkit-overflow-scrolling: touch; padding-bottom: 6px;
      scrollbar-width: thin; scrollbar-color: rgba(255,255,255,0.25) transparent;
    }
    .evalHistory::-webkit-scrollbar{ height: 6px; }
    .evalHistory::-webkit-scrollbar-track{ background: transparent; }
    .evalHistory::-webkit-scrollbar-thumb{ background: rgba(255,255,255,0.22); border-radius: 999px; }
    .evalBadge{
      display: inline-flex; align-items: center; padding: 0.26rem 0.55rem; border-radius: 999px;
      font-size: 0.68rem; font-family: 'JetBrains Mono', monospace;
      background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.09);
      color: var(--soft); flex: 0 0 auto; white-space: nowrap;
    }
    .evalBadge.latest{
      background: rgba(0,216,159,0.10); border-color: rgba(0,216,159,0.28);
      color: var(--green); font-weight: 700;
    }

    /* ‚îÄ‚îÄ‚îÄ Belief chart controls ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    .chartHeaderRight{ display:flex; align-items:center; gap: 1rem; flex-wrap: wrap; }
    .seg{ display:flex; background: rgba(255,255,255,0.04); border: 1px solid var(--border); border-radius: 10px; padding: 0.25rem; gap: 0.25rem; }
    .segBtn{ border: 0; background: transparent; color: var(--soft); font-weight: 700; font-size: 0.8125rem; padding: 0.5rem 0.875rem; border-radius: 8px; cursor:pointer; transition: all 0.2s; }
    .segBtn.active{ background: rgba(255,255,255,0.1); color: var(--text); }
    .topBelief{ display:flex; flex-direction:column; align-items:flex-end; padding-left: 1rem; border-left: 1px solid var(--border); }
    .tbLabel{ font-size: 0.6875rem; color: var(--muted); font-weight: 800; text-transform: uppercase; letter-spacing: 0.5px; }
    .tbValue{ margin-top: 0.125rem; font-family: 'JetBrains Mono'; font-size: 1rem; font-weight: 900; color: var(--yellow); }
    .chipsWrap{ display:flex; flex-wrap: wrap; gap: 0.625rem; padding: 0.875rem 1.25rem 0; }
    .chip{
      display:inline-flex; align-items:center; gap: 0.5rem;
      padding: 0.5rem 0.75rem; border-radius: 999px; border: 1px solid var(--border);
      background: rgba(255,255,255,0.04); color: var(--text); cursor: pointer;
      font-size: 0.8125rem; font-weight: 600;
    }
    .chip:hover{ border-color: rgba(255,255,255,0.15); background: rgba(255,255,255,0.06); }
    .chip.off{ opacity: 0.5; }
    .swatch{ width: 10px; height: 10px; border-radius: 3px; border: 1px solid rgba(255,255,255,0.2); }
    .fullRow{ margin-top: 1.5rem; }

    /* ‚îÄ‚îÄ‚îÄ Gap Analysis ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    .gapAnalysisList{ display: flex; flex-direction: column; gap: 0.75rem; }
    .gapCard{
      display: flex; justify-content: space-between; align-items: center;
      padding: 1rem 1.25rem; border-radius: 12px; border: 1px solid var(--border);
      background: rgba(255,255,255,0.03); gap: 1rem;
    }
    .gapCard.is-winner{ border-color: rgba(0,216,159,0.25); background: rgba(0,216,159,0.04); }
    .gapLeft{ display: flex; align-items: center; gap: 1rem; min-width: 0; flex: 1; }
    .gapModelName{ font-weight: 700; font-size: 0.9375rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .gapMetrics{ display: flex; gap: 2rem; align-items: center; }
    .gapMetricSmall{ display: flex; flex-direction: column; gap: 0.25rem; align-items: flex-start; }
    .gapLabel{ font-size: 0.6875rem; color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600; }
    .gapValue{ font-weight: 700; font-family: 'JetBrains Mono', monospace; font-size: 0.9375rem; color: var(--text); min-width: 120px; }
    .beliefChange{ font-size: 0.75rem; font-weight: 600; display: inline-block; margin-left: 0.5rem; }
    .beliefChange.up{ color: var(--green); }
    .beliefChange.down{ color: var(--red); }
    .gapRight{ display: flex; align-items: center; gap: 1rem; margin-left: 3rem; }
    .gapDiffBadge{
      padding: 0.5rem 0.875rem; border-radius: 999px;
      font-family: 'JetBrains Mono', monospace; font-size: 0.875rem; font-weight: 800;
      min-width: 80px; text-align: center;
    }
    .gapDiffBadge.overvalued{ background: rgba(255,92,124,0.15); color: var(--red); border: 1px solid rgba(255,92,124,0.3); }
    .gapDiffBadge.undervalued{ background: rgba(0,216,159,0.15); color: var(--green); border: 1px solid rgba(0,216,159,0.3); }
    .gapDiffBadge.neutral{ background: rgba(160,170,192,0.15); color: var(--soft); border: 1px solid rgba(160,170,192,0.3); }
    .gapSignalBadge{
      padding: 0.5rem 1rem; border-radius: 8px; font-size: 0.8125rem; font-weight: 800;
      text-transform: uppercase; letter-spacing: 0.5px; min-width: 130px; text-align: center;
    }
    .gapSignalBadge.overpriced{ background: rgba(255,92,124,0.2); color: var(--red); }
    .gapSignalBadge.underpriced{ background: rgba(0,216,159,0.2); color: var(--green); }
    .gapSignalBadge.aligned{ background: rgba(160,170,192,0.2); color: var(--soft); }
    .gapSignalBadge.final-winner{ background: rgba(0,216,159,0.2); color: var(--green); border: 1px solid rgba(0,216,159,0.35); }
    .gapSignalBadge.final-result{ background: rgba(160,170,192,0.12); color: var(--soft); border: 1px solid rgba(160,170,192,0.2); }
    .gapSignalBadge.loading{ background: rgba(255,184,77,0.2); color: var(--yellow); display: flex; align-items: center; gap: 0.5rem; justify-content: center; }
    .gapExplanation{
      margin-top: 1rem; padding: 1.25rem; border-top: 1px solid var(--border);
      display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;
    }
    .gapExplainItem{ display: flex; gap: 0.75rem; align-items: flex-start; }
    .gapExplainIcon{ font-size: 1.125rem; line-height: 1; margin-top: 0.125rem; }
    .gapExplainContent{ flex: 1; }
    .gapExplainTitle{ font-size: 0.8125rem; font-weight: 700; margin-bottom: 0.25rem; }
    .gapExplainTitle.underpriced{ color: var(--green); }
    .gapExplainTitle.overpriced{ color: var(--red); }
    .gapExplainTitle.aligned{ color: var(--soft); }
    .gapExplainDesc{ font-size: 0.75rem; color: var(--muted); line-height: 1.5; }
    .gapExplainFormula{ font-size: 0.6875rem; color: var(--soft); font-family: 'JetBrains Mono', monospace; margin-top: 0.25rem; }

    /* ‚îÄ‚îÄ‚îÄ Coming Soon card ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    .comingSoon{
      display: none;
      margin-top: 1.5rem; padding: 2.5rem 2rem; border-radius: 16px; text-align: center;
      border: 1px dashed rgba(255,184,77,0.3);
      background: linear-gradient(135deg, rgba(255,184,77,0.06), rgba(255,184,77,0.02));
      position: relative; overflow: hidden;
    }
    .comingSoon::before{
      content:''; position: absolute; inset: 0; pointer-events: none;
      background: radial-gradient(ellipse at 50% -10%, rgba(255,184,77,0.12) 0%, transparent 65%);
    }
    .comingSoon.visible{ display: block; }
    .csIcon{
      width: 52px; height: 52px; border-radius: 50%; margin: 0 auto 1rem;
      display: flex; align-items: center; justify-content: center; font-size: 1.5rem;
      background: rgba(255,184,77,0.12); border: 1px solid rgba(255,184,77,0.25);
      animation: csPulse 2.8s ease-in-out infinite;
    }
    @keyframes csPulse{ 0%,100%{ transform:scale(1); opacity:1; } 50%{ transform:scale(1.07); opacity:0.75; } }
    .csTitle{ font-size: 1.125rem; font-weight: 800; color: var(--yellow); margin-bottom: 0.5rem; }
    .csDesc{
      font-size: 0.875rem; color: var(--soft); line-height: 1.65;
      max-width: 500px; margin: 0 auto 1.5rem;
    }
    .csDesc a{ color: var(--yellow); text-decoration: none; font-weight: 600; }
    .csDesc a:hover{ text-decoration: underline; }
    .csDots{ display: flex; gap: 0.5rem; justify-content: center; }
    .csDot{
      width: 8px; height: 8px; border-radius: 50%;
      background: rgba(255,184,77,0.25);
    }
    .csDot:nth-child(1){ animation: dotPop 1.5s 0.0s ease-in-out infinite; }
    .csDot:nth-child(2){ animation: dotPop 1.5s 0.2s ease-in-out infinite; }
    .csDot:nth-child(3){ animation: dotPop 1.5s 0.4s ease-in-out infinite; }
    @keyframes dotPop{ 0%,100%{ transform:scale(1); background:rgba(255,184,77,0.25); } 50%{ transform:scale(1.5); background:rgba(255,184,77,0.8); } }

    /* ‚îÄ‚îÄ‚îÄ Animations ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    @keyframes spin{ from{transform:rotate(0deg)} to{transform:rotate(360deg)} }

    /* ‚îÄ‚îÄ‚îÄ Mobile ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    @media (max-width: 1024px){ .navbar{ padding: 1rem 1.25rem; } .nav-left{ gap: 1.25rem; } .nav-tabs{ flex-wrap: wrap; } }
    @media (max-width: 768px){
      .navbar{ flex-direction: column; align-items: flex-start; gap: 0.75rem; padding: 0.9rem 1rem; }
      .nav-left{ flex-direction: column; align-items: flex-start; gap: 0.75rem; width: 100%; }
      .brand{ margin-left: 0; } .brand h1{ font-size: 1.05rem; } .brand-subtitle{ font-size: 0.62rem; }
      .nav-tabs{ width: 100%; flex-wrap: nowrap; overflow-x: auto; -webkit-overflow-scrolling: touch; gap: 0.5rem; padding-bottom: 0.25rem; scrollbar-width: none; }
      .nav-tabs::-webkit-scrollbar{ height: 0; }
      .nav-tab{ flex: 0 0 auto; white-space: nowrap; padding: 0.45rem 0.7rem; font-size: 0.82rem; }
      .nav-right{ width: 100%; flex-direction: row; align-items: center; justify-content: space-between; }
      .wrap > div{ padding: 1rem !important; }
      .stats{ grid-template-columns: 1fr; gap: 0.75rem; }
      .grid{ grid-template-columns: 1fr; gap: 1rem; }
      .chartShell canvas{ height: 240px !important; }
      #delphiChartCanvas{ height: 280px !important; }
      .gapCard{ flex-direction: column; align-items: stretch; gap: 0.75rem; }
      .gapMetrics{ width: 100%; justify-content: space-between; }
      .gapRight{ width: 100%; margin-left: 0; justify-content: space-between; }
      .settledBanner{ flex-direction: column; }
    }
    @media (max-width: 420px){ .statusPill{ width:100%; justify-content:center; } }
  </style>
</head>

<body>
  <div class="navbar">
    <div class="nav-left">
      <div class="brand">
        <h1>Delphi Beliefs</h1>
        <div class="brand-subtitle">Gensyn Testnet</div>
      </div>
      <div class="nav-tabs">
        <a href="/" class="nav-tab active">Live Market</a>
        <a href="/settled-markets" class="nav-tab">Settled Markets</a>
        <a href="/what-is-delphi-beliefs" class="nav-tab">What is Delphi Beliefs?</a>
        <a href="https://delphi.gensyn.ai/" target="_blank" rel="noopener" class="nav-tab">
          Delphi Markets
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
            <polyline points="15 3 21 3 21 9"></polyline>
            <line x1="10" y1="14" x2="21" y2="3"></line>
          </svg>
        </a>
      </div>
    </div>
    <div class="nav-right">
      <div class="built-by">Built by <a href="https://github.com/gasoline2255" target="_blank" rel="noopener">gasoline</a></div>
      <div class="social-links">
        <a href="https://github.com/gasoline2255" target="_blank" rel="noopener" class="social-link" title="GitHub">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
          </svg>
        </a>
        <a href="https://x.com/gasoline2255" target="_blank" rel="noopener" class="social-link" title="X (Twitter)">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
            <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
          </svg>
        </a>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div style="padding: 2rem;">

      <!-- Top status bar -->
      <div class="topbar">
        <div class="statusPill" id="mainPill">
          <span class="dot pulse" id="mainDot"></span>
          <span id="mainPillText">Live</span>
        </div>
      </div>

      <!-- Settled banner (hidden until status=closed detected) -->
      <div class="settledBanner" id="settledBanner">
        <div class="settledBannerIcon">üèÜ</div>
        <div class="settledBannerBody">
          <div class="settledBannerTitle">Market Settled ‚Äî Final Results</div>
          <div class="settledBannerSub" id="settledBannerSub">
            This market has concluded. Data shown below reflects the final evaluation scores.
          </div>
        </div>
        <div class="settledWinnerChip" id="settledWinnerChip" style="display:none;">
          üèÜ <span id="settledWinnerName">‚Äî</span>
        </div>
      </div>

      <!-- Stat cards -->
      <div class="stats">
        <div class="card" id="sc0">
          <div class="cardInner">
            <div class="k">Market</div>
            <div class="v" id="marketName">‚Äî</div>
            <div class="splitRow"><div class="subV" id="marketNumber">Market #‚Äî</div></div>
          </div>
        </div>
        <div class="card" id="sc1">
          <div class="cardInner">
            <div class="k">Status</div>
            <div class="v" id="marketStatus">‚Äî</div>
            <div class="splitRow">
              <div class="subV">Points</div>
              <div class="subRight" id="pointsCount">0</div>
            </div>
          </div>
        </div>
        <div class="card" id="sc2">
          <div class="cardInner">
            <div class="k">Last update</div>
            <div class="v" id="lastUpdate">‚Äî</div>
            <div class="splitRow">
              <div class="subV">Auto refresh</div>
              <div class="subRight" id="refreshInfo">30s</div>
            </div>
          </div>
        </div>
        <div class="card" id="sc3">
          <div class="cardInner">
            <div class="k">Models</div>
            <div class="v" id="modelsCount">‚Äî</div>
            <div class="splitRow">
              <div class="subV">Shown</div>
              <div class="subRight" id="modelsShown">‚Äî</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Gap Analysis -->
      <div class="card" style="margin-bottom: 1.5rem;">
        <div class="cardHeader">
          <div class="cardTitle">Gap Analysis (Belief vs Market)</div>
          <div class="hintPill" id="gapPill">
            <span class="dot miniDot" style="background:#FFB84D;box-shadow:0 0 8px #FFB84D;" id="gapDot"></span>
            <span id="gapPillText">Loading...</span>
          </div>
        </div>
        <div class="body">
          <div id="gapAnalysisList"></div>
          <div class="gapExplanation" id="gapExplanation">
            <div class="gapExplainItem">
              <div class="gapExplainIcon">üü¢</div>
              <div class="gapExplainContent">
                <div class="gapExplainTitle underpriced">UNDERPRICED</div>
                <div class="gapExplainFormula">Belief &gt; Market</div>
                <div class="gapExplainDesc">Model's performance suggests higher value than current market price indicates.</div>
              </div>
            </div>
            <div class="gapExplainItem">
              <div class="gapExplainIcon">üî¥</div>
              <div class="gapExplainContent">
                <div class="gapExplainTitle overpriced">OVERPRICED</div>
                <div class="gapExplainFormula">Market &gt; Belief</div>
                <div class="gapExplainDesc">Market price exceeds what performance data alone would suggest.</div>
              </div>
            </div>
            <div class="gapExplainItem">
              <div class="gapExplainIcon">‚ö™</div>
              <div class="gapExplainContent">
                <div class="gapExplainTitle aligned">ALIGNED</div>
                <div class="gapExplainFormula">Prices match performance</div>
                <div class="gapExplainDesc">Market price closely reflects model's performance relative to competitors.</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="grid">
        <!-- Belief chart -->
        <div class="card">
          <div class="cardHeader">
            <div class="cardTitle">Belief chart</div>
            <div class="chartHeaderRight">
              <div class="seg">
                <button class="segBtn active" id="segAll">All models</button>
                <button class="segBtn" id="segOne">Single model</button>
              </div>
              <div class="topBelief">
                <div class="tbLabel">Top belief</div>
                <div class="tbValue" id="topBeliefPct">‚Äî</div>
              </div>
            </div>
          </div>
          <div class="chipsWrap" id="chipsWrap"></div>
          <div class="body">
            <div class="chartShell"><canvas id="beliefChart"></canvas></div>
            <div class="foot">
              <div>Y-axis normalized belief (0 ‚Üí 1)</div>
              <div class="miniMetaPill" id="beliefPill">
                <span class="miniDot" id="beliefDot" style="background:#FFB84D;box-shadow:0 0 8px #FFB84D;"></span>
                <span id="beliefPillText">Loading...</span>
              </div>
            </div>
            <div style="margin-top:0.75rem;padding-top:0.75rem;border-top:1px solid var(--border);font-size:0.8125rem;color:var(--soft);line-height:1.6;" id="beliefFootnote">
              Shows real-time belief based on model evaluation scores. Updates when new test results come in.
            </div>
          </div>
        </div>

        <!-- Models ranking -->
        <div class="card">
          <div class="cardHeader">
            <div class="cardTitle">Models ranking</div>
            <div class="hintPill" id="rankPill">
              <span class="dot miniDot" style="background:var(--green);box-shadow:0 0 8px var(--green);" id="rankDot"></span>
              <span id="rankPillText">Live</span>
            </div>
          </div>
          <div class="body">
            <div class="modelsList" id="modelsList"></div>
          </div>
        </div>
      </div>

      <!-- Delphi official chart -->
      <div class="card fullRow">
        <div class="cardHeader">
          <div class="cardTitle">Delphi market chart (official)</div>
          <div class="hintPill" id="delphiPill">
            <span class="dot miniDot" style="background:#FFB84D;box-shadow:0 0 8px #FFB84D;" id="delphiDot"></span>
            <span id="delphiPillText">Loading...</span>
          </div>
        </div>
        <div class="chipsWrap" id="delphiLegend"></div>
        <div class="body">
          <div class="chartShell"><canvas id="delphiChartCanvas"></canvas></div>
          <div class="foot"><div>Entry prices over time</div></div>
        </div>
      </div>

      <!-- Coming Soon (shown only when market settled and no new one yet) -->
      <div class="comingSoon" id="comingSoon">
        <div class="csIcon">‚ö°</div>
        <div class="csTitle">Next Market ‚Äî Coming Soon</div>
        <div class="csDesc">
          The next Gensyn benchmark market is being prepared. A new round of AI model evaluations will begin shortly.
          Follow <a href="https://x.com/gensyn_ai" target="_blank" rel="noopener">@gensyn_ai</a> for announcements.
        </div>
        <div class="csDots">
          <div class="csDot"></div>
          <div class="csDot"></div>
          <div class="csDot"></div>
        </div>
      </div>

    </div>
  </div>

<script>
  const REFRESH_MS = 30000;
  const MAX_POINTS = 200;
  const MARKET_ID = 4;

  // ‚îÄ‚îÄ‚îÄ Settled state ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  let marketIsSettled = false;
  let confirmedWinner = null;
  let refreshInterval = null;

  // ‚îÄ‚îÄ‚îÄ Chart data state ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  let modelNames = [];
  let MODEL_COUNT = 0;
  let timestamps = [];
  let series = [];
  let latestEvalScores = [];
  let allEvalHistory = [];
  let lastProcessedEvalCounts = [];
  let viewMode = "all";
  let activeSingleIndex = 0;
  let chipEnabled = [];
  let latestMarketPrices = {};

  // ‚îÄ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function canonicalKey(name){
    const n = String(name || "").toLowerCase().trim();
    if (n.includes("grok")) return "grok";
    if (n.includes("gemini")) return "gemini";
    if (n.includes("claude")) return "claude";
    if (n.includes("gpt")) return "gpt";
    return "other";
  }
  function colorForModelName(name){
    const k = canonicalKey(name);
    if (k === "grok")   return "#5B9FFF";
    if (k === "gemini") return "#FF9D5C";
    if (k === "claude") return "#00D89F";
    if (k === "gpt")    return "#FF5C7C";
    return "#A78BFA";
  }
  function nowLabel(){
    return new Date().toLocaleTimeString([], { hour:"2-digit", minute:"2-digit", second:"2-digit", hour12:true });
  }
  function normalize(scores){
    const cleaned = scores.map(s => (typeof s === "number" && Number.isFinite(s) ? Math.max(s,0) : 0));
    const sum = cleaned.reduce((a,b)=>a+b,0);
    if (sum <= 0) return cleaned.map(()=> cleaned.length ? 1/cleaned.length : 0);
    return cleaned.map(v=>v/sum);
  }
  function extractScore(raw){
    const arr = raw?.evals;
    if (!Array.isArray(arr) || !arr.length) return null;
    const latest = arr[arr.length-1];
    for (const k of ["aggregate","avg_score","avgScore","average_score","score","value"]){
      const v = latest?.[k];
      if (typeof v === "number" && Number.isFinite(v)) return v;
    }
    return null;
  }
  function extractScoreAtIndex(raw, idx){
    const arr = raw?.evals;
    if (!Array.isArray(arr) || idx < 0 || idx >= arr.length) return null;
    for (const k of ["aggregate","avg_score","avgScore","average_score","score","value"]){
      const v = arr[idx]?.[k];
      if (typeof v === "number" && Number.isFinite(v)) return v;
    }
    return null;
  }
  function escapeHtml(s){
    return String(s??"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
  }
  function setPillSettled(dotId, textId, pillId, text){
    const dot = document.getElementById(dotId);
    const txt = document.getElementById(textId);
    const pill = document.getElementById(pillId);
    if (dot){ dot.style.background="var(--green)"; dot.style.boxShadow="none"; }
    if (txt) txt.textContent = text || "Settled";
    if (pill) pill.classList.add("is-settled");
  }
  function setPillLive(dotId, textId, pillId, text){
    const dot = document.getElementById(dotId);
    const txt = document.getElementById(textId);
    const pill = document.getElementById(pillId);
    if (dot){ dot.style.background="var(--green)"; dot.style.boxShadow="0 0 8px var(--green)"; }
    if (txt) txt.textContent = text || "Live";
    if (pill) pill.classList.remove("is-settled");
  }
  function setPillLoading(dotId, textId){
    const dot = document.getElementById(dotId);
    const txt = document.getElementById(textId);
    if (dot){ dot.style.background="#FFB84D"; dot.style.boxShadow="0 0 8px #FFB84D"; }
    if (txt) txt.textContent = "Loading...";
  }

  // ‚îÄ‚îÄ‚îÄ Apply settled UI (called once when status=closed detected) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function applySettled(winner){
    if (marketIsSettled) return; // only run once
    marketIsSettled = true;
    confirmedWinner = winner;

    // Main pill
    const mainPill = document.getElementById("mainPill");
    const mainDot  = document.getElementById("mainDot");
    mainPill.classList.add("is-settled");
    mainDot.classList.remove("pulse");
    mainDot.classList.add("settled");
    document.getElementById("mainPillText").textContent = "Settled";

    // Settled banner
    document.getElementById("settledBanner").classList.add("visible");
    if (winner){
      document.getElementById("settledWinnerChip").style.display = "";
      document.getElementById("settledWinnerName").textContent = winner;
    }

    // Stat cards tint
    ["sc0","sc1","sc2","sc3"].forEach(id => document.getElementById(id)?.classList.add("settled-tint"));

    // Status text + refresh info
    document.getElementById("marketStatus").textContent = "Settled";
    document.getElementById("refreshInfo").textContent = "‚Äî";

    // All pills ‚Üí Settled
    setPillSettled("gapDot","gapPillText","gapPill","Settled");
    setPillSettled("beliefDot","beliefPillText","beliefPill","Settled");
    setPillSettled("rankDot","rankPillText","rankPill","Settled");
    setPillSettled("delphiDot","delphiPillText","delphiPill","Settled");

    // Footnote
    document.getElementById("beliefFootnote").textContent =
      "Final evaluation scores for this settled market. No further updates will occur.";

    // Show coming soon
    document.getElementById("comingSoon").classList.add("visible");

    // Stop auto-refresh
    if (refreshInterval){ clearInterval(refreshInterval); refreshInterval = null; }
  }

  // ‚îÄ‚îÄ‚îÄ Charts ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  Chart.defaults.color = '#6B7588';
  Chart.defaults.borderColor = 'rgba(255,255,255,0.1)';
  Chart.defaults.font.family = "'Inter', sans-serif";

  const beliefChart = new Chart(document.getElementById("beliefChart"), {
    type: "line",
    data: { labels: timestamps, datasets: [] },
    options: {
      responsive: true, maintainAspectRatio: false,
      plugins: { legend: { display:false }, tooltip: { backgroundColor:'rgba(15,18,41,0.95)', borderColor:'rgba(255,255,255,0.1)', borderWidth:1, padding:12 } },
      scales: {
        x: { grid:{ color:'rgba(255,255,255,0.05)' }, ticks:{ color:'#6B7588', font:{size:11} } },
        y: { min:0, max:1, grid:{ color:'rgba(255,255,255,0.05)' }, ticks:{ color:'#6B7588', font:{size:11}, callback: v=>(v*100).toFixed(0)+'%' } }
      }
    }
  });

  const marketChart = new Chart(document.getElementById("delphiChartCanvas"), {
    type: "line",
    data: { labels:[], datasets:[] },
    options: {
      responsive:true, maintainAspectRatio:false,
      plugins: { legend:{display:false}, tooltip:{ mode:'index', intersect:false, backgroundColor:'rgba(15,18,41,0.95)', borderColor:'rgba(255,255,255,0.1)', borderWidth:1, padding:12 } },
      scales: {
        x: { grid:{color:'rgba(255,255,255,0.05)'}, ticks:{color:'#6B7588',font:{size:11}} },
        y: { grid:{color:'rgba(255,255,255,0.05)'}, ticks:{color:'#6B7588',font:{size:11}} }
      }
    }
  });

  function updateBeliefChartScale(){
    const all = series.flat().filter(v=>typeof v==="number"&&Number.isFinite(v));
    if (!all.length) return;
    const min=Math.min(...all), max=Math.max(...all), pad=Math.max((max-min)*0.2,0.02);
    beliefChart.options.scales.y.min = Math.max(0,min-pad);
    beliefChart.options.scales.y.max = Math.min(1,max+pad);
  }

  function rebuildBeliefDatasets(){
    beliefChart.data.datasets = Array.from({length:MODEL_COUNT},(_,i)=>({
      label: modelNames[i]||`Entry #${i}`,
      data: series[i]||[],
      borderColor: colorForModelName(modelNames[i]),
      borderWidth: 2.5,
      pointRadius: ctx=>{ const l=ctx.chart.data.labels?.[ctx.dataIndex]; return l&&String(l).startsWith('Eval')?4:0; },
      pointHoverRadius: 6,
      pointBackgroundColor: colorForModelName(modelNames[i]),
      pointBorderColor: '#0A0D1F',
      pointBorderWidth: 2,
      tension: 0.4
    }));
    beliefChart.update();
  }

  function renderChips(){
    const el = document.getElementById("chipsWrap");
    el.innerHTML = modelNames.map((name,i)=>{
      const color = colorForModelName(name);
      const on = viewMode==="one" ? i===activeSingleIndex : !!chipEnabled[i];
      return `<div class="chip ${on?'':'off'}" data-idx="${i}"><span class="swatch" style="background:${color};"></span><span>${escapeHtml(name)}</span></div>`;
    }).join("");
    el.querySelectorAll(".chip").forEach(chip=>{
      chip.addEventListener("click",()=>{
        const i=Number(chip.getAttribute("data-idx"));
        if (viewMode==="one"){ activeSingleIndex=i; }
        else { chipEnabled[i]=!chipEnabled[i]; if(chipEnabled.every(v=>!v)) chipEnabled[i]=true; }
        applyViewMode(); renderChips();
      });
    });
  }

  function applyViewMode(){
    document.getElementById("segAll").classList.toggle("active",viewMode==="all");
    document.getElementById("segOne").classList.toggle("active",viewMode==="one");
    if (viewMode==="one"){ beliefChart.data.datasets.forEach((ds,i)=>ds.hidden=i!==activeSingleIndex); }
    else { beliefChart.data.datasets.forEach((ds,i)=>ds.hidden=!chipEnabled[i]); }
    beliefChart.update();
    const shown = viewMode==="one" ? 1 : chipEnabled.filter(Boolean).length;
    document.getElementById("modelsShown").textContent = `${shown}/${MODEL_COUNT}`;
  }

  document.getElementById("segAll").addEventListener("click",()=>{ viewMode="all"; chipEnabled=Array.from({length:MODEL_COUNT},()=>true); applyViewMode(); renderChips(); });
  document.getElementById("segOne").addEventListener("click",()=>{ viewMode="one"; activeSingleIndex=chipEnabled.findIndex(Boolean)||0; applyViewMode(); renderChips(); });

  // ‚îÄ‚îÄ‚îÄ Render models ranking ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function renderModels(probs){
    const rows = modelNames.map((name,i)=>({ i, name, p:probs?.[i]??0, eval:latestEvalScores?.[i]??null, evalHistory:allEvalHistory?.[i]??[] }))
      .sort((a,b)=>b.p-a.p);

    document.getElementById("modelsList").innerHTML = rows.map((r,idx)=>{
      const pct = `${Math.round(r.p*1000)/10}%`;
      const color = colorForModelName(r.name);
      const evalTxt = (typeof r.eval==="number"&&Number.isFinite(r.eval)) ? r.eval.toFixed(2) : "‚Äî";
      const isWinner = marketIsSettled && confirmedWinner &&
        r.name.trim().toLowerCase() === confirmedWinner.trim().toLowerCase();
      const winnerTag = isWinner ? `<span class="winnerTag">üèÜ Winner</span>` : "";

      const reversed = (r.evalHistory||[]).slice().reverse();
      const evalHTML = reversed.length ? `
        <div class="evalHistory">
          ${reversed.map((score,ri)=>{
            const isLatest = ri===0;
            const num = r.evalHistory.length - ri;
            return `<span class="evalBadge ${isLatest?'latest':''}">Eval #${num}: ${Number(score).toFixed(2)}</span>`;
          }).join("")}
        </div>` : "";

      return `
        <div class="modelRow ${isWinner?'is-winner':''}">
          <div class="mLeft">
            <div class="badge" style="border-color:${color}33;background:${color}18;color:${color}">#${idx+1}</div>
            <div class="mMain">
              <div class="mTop"><div class="mName">${escapeHtml(r.name)}</div></div>
              <div class="mMeta">
                <div class="mEval">Latest: ${evalTxt}</div>
                ${winnerTag}
              </div>
              ${evalHTML}
            </div>
          </div>
          <div class="pct">${pct}</div>
        </div>`;
    }).join("");

    const top = rows[0];
    if (top) document.getElementById("topBeliefPct").textContent = `${Math.round(top.p*1000)/10}%`;
  }

  // ‚îÄ‚îÄ‚îÄ Render gap analysis ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function renderGapAnalysis(beliefProbs, raw){
    const hasMarket = Object.keys(latestMarketPrices).length > 0;
    let prevProbs = null;
    const minEvals = allEvalHistory.length ? Math.min(...allEvalHistory.map(h=>h.length)) : 0;
    if (minEvals >= 2 && Array.isArray(raw) && raw.length){
      const prevScores = raw.slice(0,MODEL_COUNT).map((md,i)=>extractScoreAtIndex(md, allEvalHistory[i].length-2));
      prevProbs = normalize(prevScores.map(s=>typeof s==="number"?s:0));
    }

    const rows = modelNames.map((name,i)=>{
      const belief = beliefProbs?.[i]??0;
      const market = latestMarketPrices[name]??0;
      const gap = market - belief;
      const gapPct = Math.round(gap*1000)/10;

      let changeHtml = '';
      if (prevProbs?.[i]!==undefined){
        const ch = Math.round((belief-prevProbs[i])*1000)/10;
        if (Math.abs(ch)>=0.1){
          const cls = ch>0?'up':'down', arrow = ch>0?'‚Üë':'‚Üì', sign = ch>0?'+':'';
          changeHtml = `<span class="beliefChange ${cls}">${arrow}${sign}${ch}%</span>`;
        }
      }

      const isWinner = marketIsSettled && confirmedWinner &&
        name.trim().toLowerCase() === confirmedWinner.trim().toLowerCase();

      let signal, gapClass, signalHtml;
      if (marketIsSettled){
        signal = isWinner ? 'WINNER' : 'FINAL';
        gapClass = 'neutral';
        signalHtml = isWinner
          ? `<div class="gapSignalBadge final-winner">üèÜ WINNER</div>`
          : `<div class="gapSignalBadge final-result">FINAL</div>`;
      } else if (!hasMarket){
        signal='LOADING'; gapClass='neutral';
        signalHtml = `<div class="gapSignalBadge loading"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="animation:spin 1s linear infinite;"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>LOADING</div>`;
      } else if (Math.abs(gapPct)<5){ signal='ALIGNED'; gapClass='neutral'; signalHtml=`<div class="gapSignalBadge aligned">ALIGNED</div>`; }
      else if (gapPct>0){ signal='OVERPRICED'; gapClass='overvalued'; signalHtml=`<div class="gapSignalBadge overpriced">OVERPRICED</div>`; }
      else { signal='UNDERPRICED'; gapClass='undervalued'; signalHtml=`<div class="gapSignalBadge underpriced">UNDERPRICED</div>`; }

      return { name, belief, market, gapPct, signal, gapClass, signalHtml,
        beliefPct: `${Math.round(belief*1000)/10}%`,
        marketPct: hasMarket ? `${Math.round(market*1000)/10}%` : '‚Äî',
        gapDisplay: hasMarket ? (gapPct>0?`+${gapPct}%`:`${gapPct}%`) : '‚Äî',
        changeHtml, isWinner };
    }).sort((a,b)=>b.belief-a.belief);

    document.getElementById("gapAnalysisList").innerHTML = rows.map((r,idx)=>{
      const color = colorForModelName(r.name);
      return `
        <div class="gapCard ${r.isWinner?'is-winner':''}">
          <div class="gapLeft">
            <div class="badge" style="border-color:${color}33;background:${color}18;color:${color}">#${idx+1}</div>
            <div class="gapModelName">${escapeHtml(r.name)}</div>
          </div>
          <div class="gapMetrics">
            <div class="gapMetricSmall">
              <div class="gapLabel">Belief</div>
              <div class="gapValue"><span>${r.beliefPct}</span>${r.changeHtml}</div>
            </div>
            <div class="gapMetricSmall">
              <div class="gapLabel">Market</div>
              <div class="gapValue">${r.marketPct}</div>
            </div>
          </div>
          <div class="gapRight">
            <div class="gapDiffBadge ${r.gapClass}">${r.gapDisplay}</div>
            ${r.signalHtml}
          </div>
        </div>`;
    }).join("");

    // Update gap pill
    if (!marketIsSettled){
      if (hasMarket){ setPillLive("gapDot","gapPillText","gapPill","Live"); }
      else { setPillLoading("gapDot","gapPillText"); }
    }
  }

  function renderDelphiLegend(names){
    document.getElementById("delphiLegend").innerHTML = (names||[]).map(n=>{
      const c = colorForModelName(n);
      return `<div class="chip"><span class="swatch" style="background:${c};"></span><span>${escapeHtml(n)}</span></div>`;
    }).join("");
  }

  // ‚îÄ‚îÄ‚îÄ Main refresh ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  async function refresh(){
    const [beliefRes, delphiRes] = await Promise.all([
      fetch("/api/human-belief"),
      fetch(`/api/delphi-chart?timeframe=auto&market_id=${MARKET_ID}`)
    ]);
    const data = await beliefRes.json();
    const delphiPayload = await delphiRes.json();

    // ‚îÄ‚îÄ Detect settled status ‚îÄ‚îÄ
    const statusRaw = String(data.status || "").toLowerCase();
    if (!marketIsSettled && (statusRaw === "closed" || statusRaw === "settled")){
      // Fetch the confirmed winner from historical analysis
      try {
        const hr = await fetch("/api/historical-analysis");
        const hdata = await hr.json();
        const mkt = (hdata.markets||[]).find(m=>String(m.marketId)===String(MARKET_ID));
        applySettled(mkt?.actualWinner || null);
      } catch {
        applySettled(null);
      }
    }

    // ‚îÄ‚îÄ Models ‚îÄ‚îÄ
    if (Array.isArray(data.model_names) && data.model_names.length > 0){
      const incoming = data.model_names.slice();
      const changed = incoming.join("|") !== modelNames.join("|");
      modelNames = incoming;
      MODEL_COUNT = modelNames.length;
      if (changed || series.length !== MODEL_COUNT){
        timestamps=[]; series=Array.from({length:MODEL_COUNT},()=>[]);
        latestEvalScores=Array.from({length:MODEL_COUNT},()=>null);
        allEvalHistory=Array.from({length:MODEL_COUNT},()=>[]);
        lastProcessedEvalCounts=Array.from({length:MODEL_COUNT},()=>0);
        chipEnabled=Array.from({length:MODEL_COUNT},()=>true);
        activeSingleIndex=0; viewMode="all";
        beliefChart.data.labels=timestamps; rebuildBeliefDatasets();
      } else if (!chipEnabled.length){
        chipEnabled=Array.from({length:MODEL_COUNT},()=>true);
      }
    }

    document.getElementById("marketName").textContent = data.market_name || "Delphi market";
    document.getElementById("marketNumber").textContent = `Market #${data.market_id??"‚Äî"}`;
    if (!marketIsSettled){
      const s = statusRaw;
      document.getElementById("marketStatus").textContent = s ? s.charAt(0).toUpperCase()+s.slice(1) : "‚Äî";
    }
    document.getElementById("lastUpdate").textContent = nowLabel();
    document.getElementById("modelsCount").textContent = String(MODEL_COUNT||0);

    const raw = Array.isArray(data.raw) ? data.raw : [];
    let probs = null;

    if (MODEL_COUNT && raw.length){
      const scores = raw.slice(0,MODEL_COUNT).map(extractScore);
      latestEvalScores = scores.map(s=>(typeof s==="number"&&Number.isFinite(s))?s:null);

      allEvalHistory = raw.slice(0,MODEL_COUNT).map(md=>{
        const evals = md?.evals;
        if (!Array.isArray(evals)) return [];
        return evals.map(ev=>{
          for (const k of ["aggregate","avg_score","avgScore","average_score","score","value"]){
            const v=ev?.[k]; if(typeof v==="number"&&Number.isFinite(v)) return v;
          }
          return null;
        }).filter(v=>v!==null);
      });

      const counts = allEvalHistory.map(h=>h.length);
      const hasNew = counts.some((c,i)=>c>(lastProcessedEvalCounts[i]??0));

      if (timestamps.length===0){
        const maxE = Math.max(...counts,0);
        for (let n=1; n<=maxE; n++){
          const es = raw.slice(0,MODEL_COUNT).map(md=>extractScoreAtIndex(md,n-1));
          if (!es.some(s=>typeof s==="number"&&Number.isFinite(s))) continue;
          const p = normalize(es.map(s=>typeof s==="number"?s:0));
          timestamps.push(`Eval #${n}`); p.forEach((v,i)=>series[i].push(v));
          if (n<maxE){
            const ns=raw.slice(0,MODEL_COUNT).map(md=>extractScoreAtIndex(md,n));
            if (ns.some(s=>typeof s==="number"&&Number.isFinite(s))){
              const np=normalize(ns.map(s=>typeof s==="number"?s:0));
              timestamps.push(''); p.forEach((v,i)=>series[i].push(v+(np[i]-v)*0.3));
              timestamps.push(''); p.forEach((v,i)=>series[i].push(v+(np[i]-v)*0.7));
            }
          }
        }
        lastProcessedEvalCounts=counts.slice();
      } else if (hasNew){
        probs=normalize(latestEvalScores.map(s=>typeof s==="number"?s:0));
        const maxC=Math.max(...counts,0);
        if (series[0]?.length){
          const prev=series.map(s=>s[s.length-1]);
          timestamps.push(''); probs.forEach((p,i)=>series[i].push(prev[i]+(p-prev[i])*0.3));
          timestamps.push(''); probs.forEach((p,i)=>series[i].push(prev[i]+(p-prev[i])*0.7));
        }
        timestamps.push(`Eval #${maxC}`); probs.forEach((p,i)=>series[i].push(p));
        lastProcessedEvalCounts=counts.slice();
        if (timestamps.length>MAX_POINTS){ timestamps.shift(); series.forEach(a=>a.shift()); }
      }

      probs=normalize(latestEvalScores.map(s=>typeof s==="number"?s:0));
      beliefChart.data.labels=timestamps;
      if (beliefChart.data.datasets.length!==MODEL_COUNT) rebuildBeliefDatasets();
      beliefChart.data.datasets.forEach((ds,i)=>{
        ds.label=modelNames[i]; ds.borderColor=colorForModelName(modelNames[i]); ds.pointBackgroundColor=colorForModelName(modelNames[i]);
      });
      updateBeliefChartScale(); beliefChart.update();

      document.getElementById("pointsCount").textContent = String(timestamps.length);
      renderModels(probs);
      renderChips(); applyViewMode();
      renderGapAnalysis(probs, raw);

      if (!marketIsSettled){
        const hasMP = Object.keys(latestMarketPrices).length>0;
        if (hasMP){ setPillLive("beliefDot","beliefPillText","beliefPill","Live"); }
        else { setPillLoading("beliefDot","beliefPillText"); }
      }
    } else {
      document.getElementById("pointsCount").textContent = String(timestamps.length);
      if (!marketIsSettled) setPillLoading("beliefDot","beliefPillText");
    }

    // ‚îÄ‚îÄ Delphi official chart ‚îÄ‚îÄ
    const mc = delphiPayload?.market_chart;
    const entryMap = delphiPayload?.entry_map || {};
    const points = mc?.data_points;

    if (Array.isArray(points) && points.length>0){
      const labels = points.map(p=>{
        const d=new Date(Number(p.timestamp)*1000);
        return d.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"});
      });
      const entryCount = Number(mc?.entry_count||0);
      const entryNames = Array.from({length:entryCount},(_,i)=>entryMap[String(i)]||`Entry #${i}`);

      const latestPt = points[points.length-1];
      if (latestPt?.entries){
        latestPt.entries.forEach(ent=>{
          const name=entryMap[String(ent.entry_idx)]; if(!name) return;
          const v=typeof ent.price==="string"?Number(ent.price):typeof ent.price==="number"?ent.price:NaN;
          if (Number.isFinite(v)) latestMarketPrices[name]=v;
        });
        if (probs && raw?.length) renderGapAnalysis(probs,raw);
        if (!marketIsSettled){ setPillLive("beliefDot","beliefPillText","beliefPill","Live"); }
      }

      marketChart.data.labels=labels;
      marketChart.data.datasets=Array.from({length:entryCount},(_,ei)=>{
        const label=entryNames[ei], color=colorForModelName(label);
        return { label, borderColor:color, borderWidth:2.5, pointRadius:0, tension:0.3,
          data:points.map(p=>{ const e=(p.entries||[]).find(e=>String(e.entry_idx)===String(ei)); const v=typeof e?.price==="string"?Number(e.price):typeof e?.price==="number"?e.price:NaN; return Number.isFinite(v)?v:null; }) };
      });
      marketChart.update();
      renderDelphiLegend(entryNames);

      if (!marketIsSettled){
        setPillLive("delphiDot","delphiPillText","delphiPill","Live");
      }
    }
  }

  let isRefreshing = false;
  async function safeRefresh(){
    if (isRefreshing) return;
    isRefreshing=true;
    try { await refresh(); }
    catch(e){ console.error(e); }
    finally { isRefreshing=false; }
  }

  // Init
  refreshInterval = setInterval(safeRefresh, REFRESH_MS);
  safeRefresh();
</script>
</body>
</html>